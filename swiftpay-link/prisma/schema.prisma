generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  SELLER_ADMIN
  OPERATOR
}

enum OrderStatus {
  DRAFT
  PENDING_PAYMENT
  PAID
  CANCELED
  FAILED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
}

enum PaymentMethod {
  MIA
  CARD
  APPLE_PAY
  GOOGLE_PAY
}

enum DeliveryMethod {
  COURIER
  PICKUP
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         UserRole
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Seller {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logoUrl   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]
  links    Link[]
  orders   Order[]
}

model Product {
  id          String      @id @default(cuid())
  sellerId    String
  name        String
  description String?
  basePrice   Decimal     @db.Decimal(10, 2)
  imageUrl    String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  seller   Seller          @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  variants ProductVariant[]
}

model ProductVariant {
  id        String   @id @default(cuid())
  productId String
  sku       String?  @unique
  color     String?
  size      String?
  stock     Int      @default(0)
  price     Decimal? @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  linkItems LinkItem[]
  cartItems CartItem[]
  orderItems OrderItem[]
}

model Link {
  id        String   @id @default(cuid())
  code      String   @unique
  sellerId  String
  name      String
  active    Boolean  @default(true)
  expiresAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  seller   Seller    @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  items    LinkItem[]
  events   EventLog[]
}

model LinkItem {
  id                String          @id @default(cuid())
  linkId            String
  productVariantId  String
  quantity          Int             @default(1)
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  link              Link            @relation(fields: [linkId], references: [id], onDelete: Cascade)
  productVariant    ProductVariant  @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
}

model Cart {
  id        String   @id @default(cuid())
  cartToken String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items CartItem[]
}

model CartItem {
  id               String          @id @default(cuid())
  cartId           String
  productVariantId String
  quantity         Int             @default(1)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  cart            Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productVariant  ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Restrict)

  @@index([cartId])
  @@index([productVariantId])
  @@unique([cartId, productVariantId])
}

model EventLog {
  id        String   @id @default(cuid())
  type      String
  payload   Json?
  createdAt DateTime @default(now())

  linkId String?
  link   Link? @relation(fields: [linkId], references: [id], onDelete: SetNull)
}

model Order {
  id             String         @id @default(cuid())
  orderNumber    String         @unique
  sellerId       String
  customerName   String
  customerEmail  String
  customerPhone  String
  deliveryMethod DeliveryMethod
  deliveryAddress String
  deliveryCity    String
  deliveryZip     String?
  customerNote    String?
  currency       String        @default("MDL")
  subtotal       Decimal       @db.Decimal(10, 2)
  deliveryFee    Decimal       @db.Decimal(10, 2) @default(0)
  totalAmount    Decimal       @db.Decimal(10, 2)
  status         OrderStatus   @default(PENDING_PAYMENT)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  seller   Seller     @relation(fields: [sellerId], references: [id], onDelete: Restrict)
  items    OrderItem[]
  payment  Payment?
}

model OrderItem {
  id               String         @id @default(cuid())
  orderId          String
  productVariantId String
  productName      String
  variantLabel     String?
  unitPrice        Decimal        @db.Decimal(10, 2)
  quantity         Int
  lineTotal        Decimal        @db.Decimal(10, 2)
  createdAt        DateTime       @default(now())

  order          Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productVariant ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Restrict)

  @@index([orderId])
}

model Payment {
  id        String         @id @default(cuid())
  orderId   String         @unique
  method    PaymentMethod
  status    PaymentStatus  @default(PENDING)
  amount    Decimal        @db.Decimal(10, 2)
  currency  String         @default("MDL")
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
}
